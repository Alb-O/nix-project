#!/usr/bin/env bash
# Pre-commit hook to sync scripts across branches and maintain documentation

set -euo pipefail

# Function to create symbolic links for agent documentation
setup_agent_docs() {
    # Check if AGENTS.md is being committed
    if git diff --cached --name-only | grep -q "^AGENTS\.md$"; then
        echo "AGENTS.md changes detected, updating symbolic links..."
        
        if [[ -f "AGENTS.md" ]]; then
            # Remove existing files if they exist
            rm -f "CLAUDE.md" ".github/copilot-instructions.md"
            
            # Create symbolic links
            ln -sf "AGENTS.md" "CLAUDE.md"
            ln -sf "../AGENTS.md" ".github/copilot-instructions.md"
            
            # Add the symbolic links to this commit
            git add "CLAUDE.md" ".github/copilot-instructions.md"
            
            echo "Created symbolic links: CLAUDE.md and .github/copilot-instructions.md -> AGENTS.md"
        else
            echo "Warning: AGENTS.md not found"
        fi
    fi
}

# Setup agent documentation links if needed
setup_agent_docs

# Only run script sync setup if we're committing script changes
if git diff --cached --name-only | grep -q "^scripts/"; then
    echo "Script changes detected in commit, will sync across branches after commit..."
    
    # Create a flag file to trigger post-commit sync
    touch .git/SCRIPT_SYNC_NEEDED
fi

exit 0